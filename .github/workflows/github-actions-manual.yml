# Yml file for the automation CI job

name: Run automation tests with parameters

env:
  SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
  SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'The tag of the test or tests which you want to run'
        required: true
        default: '@homework'
      browser:
        description: 'Name of the browser from browser-capabilities-sauce-labs.js'
        required: true
        default: 'chrome'

jobs:
  start-runner:
    name: Start self-hosted EC2 runner
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_SBX_RUNNER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_SBX_RUNNER }}
          aws-region: us-east-1

      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: start
          github-token: ${{ secrets.PAT_GH_RUNNER_SBX }}
          ec2-image-id: ami-0cbbec64a81292b92
          ec2-instance-type: t3.large
          subnet-id: subnet-02a29c00c433e840e
          security-group-id: sg-00773faef328ef4a4

      - name: Associate EIP to instance
        env:
          INSTANCE_ID: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
          ALLOCATION_ID: eipalloc-0021acdb1321e3033
        run: |
          aws --region us-east-1 ec2 associate-address --instance-id "${INSTANCE_ID}" --allocation-id "${ALLOCATION_ID}"

  run-automation-tests:
    name: Run automation tests from self-hosted runner
    needs: [start-runner]
    runs-on: ${{ needs.start-runner.outputs.label }} # run the job on the newly created runner
    steps:
      - uses: actions/checkout@v3

      - name: Installing dependencies
        working-directory: ./
        run: yarn

      - name: Start running automated tests with custom arguments in SauceLabs...
        working-directory: ./
        run: yarn remote tag=${{ github.event.inputs.tag }} browser=${{ github.event.inputs.browser }}

      - name: Get Allure history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Allure Report action from marketplace
        uses: simple-elf/allure-report-action@master
        if:
          always()
          #id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history

      - name: Post the link to the generated Allure Report
        run: echo "https://coin-cloud.github.io/coincloud-automation/${{ github.run_number }}"

  stop-runner:
    name: Stop self-hosted EC2 runner
    needs: [run-automation-tests, start-runner]
    runs-on: ubuntu-latest # self-hosted
    if: ${{ always() }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_SBX_RUNNER }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_SBX_RUNNER }}
          aws-region: us-east-1
      - name: Stop EC2 runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: stop
          github-token: ${{ secrets.PAT_GH_RUNNER_SBX }}
          label: ${{ needs.start-runner.outputs.label }}
          ec2-instance-id: ${{ needs.start-runner.outputs.ec2-instance-id }}
